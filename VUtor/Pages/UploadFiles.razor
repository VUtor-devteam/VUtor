@page "/uploadfiles"

@using DataAccessLibrary.Data
@using DataAccessLibrary.FileRepo;
@using DataAccessLibrary.FolderRepo;
@using DataAccessLibrary.Models
@using DataAccessLibrary
@using Microsoft.AspNetCore.Identity;
@using Microsoft.EntityFrameworkCore
@using VUtor.Components;



@inject IConfiguration config 
@inject IGenericRepository<TopicEntity> topicRepo
@inject UserManager<ProfileEntity> userManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IFileRepository fileRepo
@inject IFolderRepository folderRepo



<h3>UploadFiles</h3>

<EditForm Model="@uploadFileModel"  OnSubmit="SubmitForm">
    <div>
        <label for="Title" class="custom_small_text">Enter resource title</label>
        <InputText id="title" class="form-control" @bind-Value="uploadFileModel.Title"></InputText>
    </div>
    <div>
        <label for="Description" class="custom_small_text">Enter a short description</label>
        <InputText id="description" class="form-control" @bind-Value="uploadFileModel.Description"></InputText>
    </div>
    <div>
        <label for="TopicId" class="custom_small_text">Choose topic</label>
            <select id="topics" class="form-control" @onchange="UpdateTopicsId">
                <option value="">Select a topic...</option>
                @foreach (var topic in topicList)
                {
                    <option value="@topic.Id" class="custom_small_text">@topic.Title</option>
                }
            </select>
    </div>
    <div>
        @if (uploadFileModel.TopicsId.Any())
        {
            <label style="margin-top: 10px" class="custom_small_text">Selected Topics:</label>
            @foreach (var topicId in uploadFileModel.TopicsId)
            {
                var topic = topicList.First(t => t.Id == topicId);
                <li>@topic.Title <button @onclick="() => RemoveTopic(topicId)" type="button" class="round_corners_small btn btn-outline-secondary">X</button></li>
            }
        }
    </div>
    <div>
        <label for="FoldersId" class="custom_small_text">Choose where to store</label>
        <div>
            @if(selectedFolder != null){
                <p class="custom_small_text">@selectedFolder.Path</p>
            }
        </div>
    <div>
        @if(selectedFolder == null){
            <div>
                @if (folderList != null)
                {
                    <select id="folder" style="margin-bottom: 10px" class="form-control-sm" @onchange="FolderSelected">
                    <option value="">Select a folder...</option>
                    @foreach (var folder in folderList)
                    {
                        <option value="@folder.Id" class="custom_small_text">@folder.Name</option>
                    }
                    </select>
                }
            </div>
            <div>
                <input type="text" style="margin-bottom: 10px" @bind="newFolderName" placeholder="New folder name" />
            </div>
            <div>
                    <button @onclick="CreateNewFolder" style="margin-bottom: 10px; width: 170px; padding: 0 10px 0 10px" type="button" class="round_corners btn btn-outline-secondary">Create New Folder</button>
            </div>
        }else{
            <FolderComp CurrentFolder="@selectedFolder" OnFolderSelected="HandleFolderSelected"/>
        }
    </div>
    </div>
        <div>
            <label for="File"class="custom_small_text">Upload your file</label>
            <InputFile OnChange="@LoadFiles" style="margin-bottom: 10px" class="form-control" />
        </div>
    <button @onclick="CaptureFile" style="margin-bottom: 10px; width: 100px; padding: 0 10px 0 10px" class="round_corners btn btn-outline-secondary" type="submit">Upload</button>
</EditForm>


@if(errors.Count() > 0)
{
    <h2>Errors</h2>
    <ul class="text-danger">
        @foreach(var error in errors)
        {
            <li>@error</li>
        }
    </ul>
}

@code {
    private UploadFileModel uploadFileModel = new UploadFileModel();
    private List<TopicEntity> topicList;
    private List<string> errors = new();
    private Folder selectedFolder;
    private IBrowserFile? file;
    private List<Folder> folderList;
    private ProfileEntity? profile;
    private string newFolderName;

    public class UploadFileModel(){
        public string Title { get; set; }
        public string? Description { get; set; }
        public List<int> TopicsId { get; set; } = new List<int>();
    }

    // LOADING DATA FOR PAGE AND UPLOADING ACTIONS -----------------------------------------
    protected override async Task OnInitializedAsync()
    {
        try
        {
            topicList = await topicRepo.LoadData();
            folderList = await folderRepo.GetParentFolders();
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity.IsAuthenticated)
            {
                profile = await userManager.GetUserAsync(user);
            }
        }
        catch (Exception ex)
        {
            errors.Add("Error initializing page.");
        }
    }
    // LOADING DATA FOR PAGE AND UPLOADING ACTIONS -----------------------------------------


    // FOLDER SELECTING/CREATING SYSTEM ---------------------------------------------------
    private async Task FolderSelected(ChangeEventArgs e)
    {
        try
        {
            var selectedFolderId = int.Parse(e.Value.ToString());
            selectedFolder = await folderRepo.GetFolder(selectedFolderId);
        }
        catch (Exception ex)
        {
            errors.Add("Error selecting folder.");
        }
    }

    private async Task CreateNewFolder()
    {
        try
        {
            if (!string.IsNullOrEmpty(newFolderName))
            {
                await folderRepo.CreateFolder(newFolderName);
                await UpdateFolderList();
            }
            newFolderName = string.Empty;
        }
        catch (Exception ex)
        {
            errors.Add("Error creating new folder.");
        }
    }

    private void HandleFolderSelected(Folder folder)
    {
        selectedFolder = folder;
    }

    private async Task UpdateFolderList()
    {
        try
        {
            folderList = await folderRepo.GetParentFolders();
        }
        catch (Exception ex)
        {
            errors.Add("Error updating folder list.");
        }
    }
    // FOLDER SELECTING/CREATING SYSTEM ---------------------------------------------------

    private void UpdateTopicsId(ChangeEventArgs e)
    {
        try
        {
            var selectedOption = int.Parse(e.Value.ToString());
            if (!uploadFileModel.TopicsId.Contains(selectedOption))
            {
                uploadFileModel.TopicsId.Add(selectedOption);
            }
        }
        catch (Exception ex)
        {
            errors.Add("Error updating topics ID.");
        }
    }

    private void RemoveTopic(int topicId)
    {
        if (uploadFileModel.TopicsId.Contains(topicId))
        {
            uploadFileModel.TopicsId.Remove(topicId);
        }
        else
        {
            errors.Add($"Topic ID {topicId} not found in list.");
        }
    }

    private void LoadFiles(InputFileChangeEventArgs e)
    {
        try
        {
            file = e.File;
        }
        catch (Exception ex)
        {
            errors.Add("Error loading file.");
        }
    }

        private async Task CaptureFile()
    {
        if(file == null || file.Name == null)
        {
            errors.Add("No file was loaded.");
            return;
        }

        if(selectedFolder == null)
        {
            errors.Add("No folder selected.");
            return;
        }

        if(profile == null)
        {
            errors.Add("No profile found.");
            return;
        }

        try
        {
            await fileRepo.UploadFileAsync(file, file.Name, uploadFileModel.Title, uploadFileModel.Description, uploadFileModel.TopicsId, selectedFolder.Id, profile.Id);
            Console.WriteLine(selectedFolder.Path);
            uploadFileModel.Title = String.Empty;
            uploadFileModel.Description = String.Empty;
            uploadFileModel.TopicsId.Clear();
            selectedFolder = null;
        }
        catch (Exception ex)
        {
            errors.Add($"File: {file.Name} Error.");
        }
    }

    private async Task SubmitForm()
    {
        errors.Clear();
    }

}



